<!-- Load Libsodium with fallback -->
<script>
  function loadSodium() {
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/libsodium-wrappers@0.7.11/dist/browsers/sodium.min.js';
      script.integrity = 'sha384-6k0WZYAxEsKzF0EEy1eNs8E0XvcYJQbrD1XjPBH+ZP5vX/0aOxZ8fY5f9Q9pWw==';
      script.crossOrigin = 'anonymous';
      
      script.onload = () => {
        console.log('Libsodium loaded successfully');
        resolve();
      };
      
      script.onerror = () => {
        console.warn('Primary CDN failed, trying fallback...');
        const fallback = document.createElement('script');
        fallback.src = 'https://cdnjs.cloudflare.com/ajax/libs/libsodium-wrappers/0.7.11/sodium.min.js';
        fallback.onload = () => resolve();
        fallback.onerror = () => reject(new Error('All CDN attempts failed'));
        document.head.appendChild(fallback);
      };
      
      document.head.appendChild(script);
    });
  }

  // Enhanced error display
  function showError(message, details = '') {
    const errorHtml = `
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
          justify-content: center; align-items: center; color: #f00; 
          text-align: center; padding: 20px; flex-direction: column;">
          <h1 style="color: #f00; margin-bottom: 20px;">
              <i class="fas fa-exclamation-triangle"></i> Critical Error
          </h1>
          <div style="font-size: 1.2rem; margin-bottom: 20px;">${message}</div>
          <div style="margin-bottom: 30px; color: #aaa;">${details}</div>
          <button onclick="window.location.reload()" 
              style="padding: 10px 20px; background: #f00; color: white; 
              border: none; border-radius: 5px; cursor: pointer;">
              <i class="fas fa-sync-alt"></i> Refresh Page
          </button>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', errorHtml);
  }

  // Start application
  document.addEventListener('DOMContentLoaded', () => {
    loadSodium()
      .then(() => initializeApplication())
      .catch(err => {
        showError('Encryption library failed to load', 
                'Please check your internet connection and refresh the page');
        console.error('Libsodium loading error:', err);
      });
  });
</script>
